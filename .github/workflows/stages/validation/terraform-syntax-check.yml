name: Terraform Syntax Check

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  terraform-syntax:
    name: "Terraform Syntax - ${{ inputs.environment }}"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4
      
      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
      
      - name: "Install Terragrunt"
        run: |
          TG_VERSION=v0.58.14
          curl -L https://github.com/gruntwork-io/terragrunt/releases/download/${TG_VERSION}/terragrunt_linux_amd64 \
            -o /usr/local/bin/terragrunt
          chmod +x /usr/local/bin/terragrunt
      
      - name: "Validate Terraform Syntax"
        working-directory: infra/live/${{ inputs.environment }}
        run: |
          echo "Validating Terraform syntax for ${{ inputs.environment }}..."
          
          # Find all Terragrunt configurations
          MODULES=$(find . -name "terragrunt.hcl" -type f | xargs -n1 dirname | sort)
          TOTAL_MODULES=$(echo "$MODULES" | wc -l)
          CURRENT=1
          
          echo "Found $TOTAL_MODULES modules to validate"
          
          for MODULE in $MODULES; do
            echo "[$CURRENT/$TOTAL_MODULES] Checking: $MODULE"
            cd "$MODULE"
            
            # Initialize without backend
            if terragrunt init -backend=false 2>/dev/null; then
              echo "  Init successful"
            else
              echo "  Init warning (expected for some modules)"
            fi
            
            # Validate syntax
            if terragrunt validate -no-color 2>/dev/null; then
              echo "  Syntax valid"
            else
              echo "  Invalid syntax in $MODULE"
              echo "  Running detailed validation..."
              terragrunt validate -no-color
              exit 1
            fi
            
            cd - > /dev/null
            CURRENT=$((CURRENT + 1))
          done
          
          echo "All $TOTAL_MODULES modules have valid Terraform syntax"