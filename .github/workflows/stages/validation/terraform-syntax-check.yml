name: Terraform Syntax Check

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  terraform-syntax:
    name: "ðŸ” Terraform Syntax - ${{ inputs.environment }}"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4
      
      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
      
      - name: "ðŸ“¦ Install Terragrunt"
        run: |
          TG_VERSION=v0.58.14
          curl -L https://github.com/gruntwork-io/terragrunt/releases/download/${TG_VERSION}/terragrunt_linux_amd64 \
            -o /usr/local/bin/terragrunt
          chmod +x /usr/local/bin/terragrunt
      
      - name: "âœ… Validate Terraform Syntax"
        working-directory: infra/live/${{ inputs.environment }}
        run: |
          echo "ðŸ” Validating Terraform syntax for ${{ inputs.environment }}..."
          
          # Find all Terragrunt configurations
          MODULES=$(find . -name "terragrunt.hcl" -type f | xargs -n1 dirname | sort)
          TOTAL_MODULES=$(echo "$MODULES" | wc -l)
          CURRENT=1
          
          echo "ðŸ“‹ Found $TOTAL_MODULES modules to validate"
          
          for MODULE in $MODULES; do
            echo "[$CURRENT/$TOTAL_MODULES] Checking: $MODULE"
            cd "$MODULE"
            
            # Initialize without backend
            if terragrunt init -backend=false 2>/dev/null; then
              echo "  âœ… Init successful"
            else
              echo "  âš ï¸ Init warning (expected for some modules)"
            fi
            
            # Validate syntax
            if terragrunt validate -no-color 2>/dev/null; then
              echo "  âœ… Syntax valid"
            else
              echo "  âŒ Invalid syntax in $MODULE"
              echo "  ðŸ” Running detailed validation..."
              terragrunt validate -no-color
              exit 1
            fi
            
            cd - > /dev/null
            CURRENT=$((CURRENT + 1))
          done
          
          echo "âœ… All $TOTAL_MODULES modules have valid Terraform syntax"