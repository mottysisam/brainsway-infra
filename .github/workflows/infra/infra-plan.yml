name: Infrastructure Planning

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      changed_modules:
        required: false
        type: string
        default: '{}'

jobs:
  # Stage 1: Execute Terragrunt plan
  terragrunt_plan:
    name: " Terragrunt Plan"
    uses: ./.github/workflows/stages/planning/terragrunt-plan.yml
    with:
      environment: ${{ inputs.environment }}
    secrets: inherit
  
  # Stage 2: Analyze plan output in detail
  plan_analysis:
    name: " Plan Analysis"
    needs: terragrunt_plan
    uses: ./.github/workflows/stages/planning/plan-analysis.yml
    with:
      environment: ${{ inputs.environment }}
      plan_artifact_name: terragrunt-plan-${{ inputs.environment }}
  
  # Summary job to aggregate results
  planning_summary:
    name: " Planning Summary"
    needs: [terragrunt_plan, plan_analysis]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.summary.outputs.has_changes }}
      plan_status: ${{ steps.summary.outputs.plan_status }}
    
    steps:
      - name: "generate_planning_summary"
        id: summary
        run: |
          echo "##  Infrastructure Planning Summary - ${{ inputs.environment }}"
          echo ""
          echo "**Environment:** ${{ inputs.environment }}"
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "### Planning Results:"
          echo "- **Terragrunt Plan:** ${{ needs.terragrunt_plan.result }}"
          echo "- **Plan Analysis:** ${{ needs.plan_analysis.result }}"
          echo ""
          
          # Determine overall status and extract key information
          if [ "${{ needs.terragrunt_plan.result }}" = "success" ]; then
            echo "###  Overall Status: PASSED"
            echo "Planning completed successfully."
            echo "plan_status=success" >> $GITHUB_OUTPUT
          else
            echo "###  Overall Status: FAILED"
            echo "Planning failed. Review the details above."
            echo "plan_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Note: has_changes detection would need to be passed from terragrunt-plan stage
          # For now, assuming changes exist if planning succeeded
          echo "has_changes=true" >> $GITHUB_OUTPUT