name: Infrastructure Planning

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      changed_modules:
        required: false
        type: string
        default: '{}'

jobs:
  # Stage 1: Execute Terragrunt plan
  terragrunt-plan:
    name: "ðŸ“‹ Terragrunt Plan"
    uses: ./.github/workflows/stages/planning/terragrunt-plan.yml
    with:
      environment: ${{ inputs.environment }}
    secrets: inherit
  
  # Stage 2: Analyze plan output in detail
  plan-analysis:
    name: "ðŸ” Plan Analysis"
    needs: terragrunt-plan
    uses: ./.github/workflows/stages/planning/plan-analysis.yml
    with:
      environment: ${{ inputs.environment }}
      plan_artifact_name: terragrunt-plan-${{ inputs.environment }}
  
  # Summary job to aggregate results
  planning-summary:
    name: "ðŸ“Š Planning Summary"
    needs: [terragrunt-plan, plan-analysis]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.summary.outputs.has_changes }}
      plan_status: ${{ steps.summary.outputs.plan_status }}
    
    steps:
      - name: "ðŸ“Š Generate Planning Summary"
        id: summary
        run: |
          echo "## ðŸ“Š Infrastructure Planning Summary - ${{ inputs.environment }}"
          echo ""
          echo "**Environment:** ${{ inputs.environment }}"
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "### Planning Results:"
          echo "- **Terragrunt Plan:** ${{ needs.terragrunt-plan.result }}"
          echo "- **Plan Analysis:** ${{ needs.plan-analysis.result }}"
          echo ""
          
          # Determine overall status and extract key information
          if [ "${{ needs.terragrunt-plan.result }}" = "success" ]; then
            echo "### âœ… Overall Status: PASSED"
            echo "Planning completed successfully."
            echo "plan_status=success" >> $GITHUB_OUTPUT
          else
            echo "### âŒ Overall Status: FAILED"
            echo "Planning failed. Review the details above."
            echo "plan_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Note: has_changes detection would need to be passed from terragrunt-plan stage
          # For now, assuming changes exist if planning succeeded
          echo "has_changes=true" >> $GITHUB_OUTPUT