name: Infrastructure Validation

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  # Stage 1: Terraform syntax validation
  terraform-syntax:
    name: "ğŸ” Terraform Syntax"
    uses: ./.github/workflows/stages/validation/terraform-syntax-check.yml
    with:
      environment: ${{ inputs.environment }}
  
  # Stage 2: State backend verification
  state-backend:
    name: "ğŸ—„ï¸ State Backend"
    uses: ./.github/workflows/stages/validation/state-backend-check.yml
    with:
      environment: ${{ inputs.environment }}
    secrets: inherit
  
  # Stage 3: Module dependency check
  module-dependencies:
    name: "ğŸ“¦ Module Dependencies"
    uses: ./.github/workflows/stages/validation/module-dependency-check.yml
    with:
      environment: ${{ inputs.environment }}
  
  # Summary job to aggregate results
  validation-summary:
    name: "ğŸ“Š Validation Summary"
    needs: [terraform-syntax, state-backend, module-dependencies]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“Š Generate Validation Summary"
        run: |
          echo "## ğŸ“Š Infrastructure Validation Summary - ${{ inputs.environment }}"
          echo ""
          echo "**Environment:** ${{ inputs.environment }}"
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "### Validation Results:"
          echo "- **Terraform Syntax:** ${{ needs.terraform-syntax.result }}"
          echo "- **State Backend:** ${{ needs.state-backend.result }}"
          echo "- **Module Dependencies:** ${{ needs.module-dependencies.result }}"
          echo ""
          
          # Determine overall status
          if [ "${{ needs.terraform-syntax.result }}" = "success" ] && \
             [ "${{ needs.state-backend.result }}" = "success" ] && \
             [ "${{ needs.module-dependencies.result }}" = "success" ]; then
            echo "### âœ… Overall Status: PASSED"
            echo "All validation checks completed successfully."
          else
            echo "### âŒ Overall Status: FAILED"
            echo "One or more validation checks failed. Review the details above."
            exit 1
          fi