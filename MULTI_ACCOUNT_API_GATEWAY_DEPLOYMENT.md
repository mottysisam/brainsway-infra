# Multi-Account API Gateway DNS Solution - Deployment Guide

> **Generated by Claude on 2025-08-12**  
> Complete deployment instructions for multi-account HTTP API Gateway v2 with DNS delegation

---

## ğŸ¯ **Overview**

This guide provides step-by-step instructions for deploying the multi-account HTTP API Gateway v2 infrastructure with DNS delegation across dev, staging, and production environments.

### **Architecture**
- **Dev**: `api.dev.brainsway.cloud` â†’ dev account (824357028182)
- **Staging**: `api.staging.brainsway.cloud` â†’ staging account (574210586915)  
- **Production**: `api.brainsway.cloud` â†’ prod account (154948530138)

---

## âš™ï¸ **Configuration Requirements**

### **Critical Configuration Update Required**

**ğŸš¨ MANDATORY**: Replace `PARENT_ZONE_ID` placeholder in the following files:

1. `/infra/live/prod/us-east-2/apigw-http/delegate-route53-dev/terragrunt.hcl`
2. `/infra/live/prod/us-east-2/apigw-http/delegate-route53-staging/terragrunt.hcl`

**Find this line:**
```hcl
parent_zone_id  = "PARENT_ZONE_ID"  # <<<<<<<<<< REPLACE with brainsway.cloud Zone ID in PROD
```

**Replace with actual Route53 zone ID for brainsway.cloud:**
```bash
# Get the zone ID from AWS CLI
aws route53 list-hosted-zones --query "HostedZones[?Name=='brainsway.cloud.'].Id" --output text --profile bwamazonprod
```

### **Prerequisites Checklist**
- âœ… AWS CLI profiles configured: `bwamazondev`, `bwamazonstaging`, `bwamazonprod`
- âœ… Cross-account IAM roles exist: `TerraformCrossAccountRole` in each account
- âœ… Terragrunt and Terraform installed and configured
- âœ… Parent zone ID for `brainsway.cloud` identified

---

## ğŸš€ **Deployment Order** 

**âš ï¸ CRITICAL**: Follow this exact order for cross-account dependencies to resolve correctly.

### **Phase 1: Create Subzones (Dev & Staging Accounts)**
```bash
# 1. Create dev subzone (dev.brainsway.cloud)
cd infra/live/dev/us-east-2/apigw-http/route53
terragrunt apply

# 2. Create staging subzone (staging.brainsway.cloud)  
cd infra/live/staging/us-east-2/apigw-http/route53
terragrunt apply
```

**Expected Output**: Each command should create a hosted zone and output name servers.

### **Phase 2: Create Delegations (Production Account)**
```bash
# 3. Delegate dev.brainsway.cloud from production
cd infra/live/prod/us-east-2/apigw-http/delegate-route53-dev
terragrunt apply

# 4. Delegate staging.brainsway.cloud from production
cd infra/live/prod/us-east-2/apigw-http/delegate-route53-staging  
terragrunt apply
```

**Expected Output**: NS records created in parent zone pointing to child zone name servers.

### **Phase 3: SSL Certificates** 
```bash
# 5. Request SSL certificates (requires functioning DNS delegation)
cd infra/live/dev/us-east-2/api-gateway-v2/acm
terragrunt apply

cd infra/live/staging/us-east-2/api-gateway-v2/acm
terragrunt apply

cd infra/live/prod/us-east-2/api-gateway-v2/acm
terragrunt apply
```

**Expected Output**: ACM certificates in ISSUED status with DNS validation.

### **Phase 4: Lambda Functions**
```bash
# 6. Deploy Lambda routers with environment-specific variables
cd infra/live/dev/us-east-2/api-gateway-v2/lambda
terragrunt apply

cd infra/live/staging/us-east-2/api-gateway-v2/lambda  
terragrunt apply

cd infra/live/prod/us-east-2/api-gateway-v2/lambda
terragrunt apply
```

### **Phase 5: API Gateways**
```bash
# 7. Deploy HTTP API Gateways v2 with custom domains
cd infra/live/dev/us-east-2/api-gateway-v2/api-gateway
terragrunt apply

cd infra/live/staging/us-east-2/api-gateway-v2/api-gateway
terragrunt apply

cd infra/live/prod/us-east-2/api-gateway-v2/api-gateway
terragrunt apply
```

### **Phase 6: Security (Optional)**
```bash
# 8. Deploy WAF for production (optional but recommended)
cd infra/live/prod/us-east-2/api-gateway-v2/waf
terragrunt apply
```

---

## âœ… **Validation Commands**

### **DNS Delegation Verification**
```bash
# Verify dev delegation works
dig +short NS dev.brainsway.cloud @8.8.8.8
dig +trace api.dev.brainsway.cloud

# Verify staging delegation works  
dig +short NS staging.brainsway.cloud @8.8.8.8
dig +trace api.staging.brainsway.cloud

# Test DNS resolution end-to-end
dig A api.dev.brainsway.cloud
dig A api.staging.brainsway.cloud
dig A api.brainsway.cloud
```

**Expected Output**: Each command should resolve to API Gateway regional endpoints.

### **API Endpoint Testing**
```bash
# Test health endpoints (if enabled)
curl -v https://api.dev.brainsway.cloud/health
curl -v https://api.staging.brainsway.cloud/health  
curl -v https://api.brainsway.cloud/health

# Test CORS headers
curl -H "Origin: https://app.brainsway.cloud" -v https://api.brainsway.cloud/health
```

### **CloudWatch Logs Verification**
**Note**: Log groups use the pattern `/apigw/{api-name}/{stage}/access` (NOT `/aws/apigatewayv2/...`)

```bash
# Check dev environment logs
aws logs describe-log-groups \
  --log-group-name-prefix "/apigw/brainsway-api-dev/v1/" \
  --profile bwamazondev

# Check staging environment logs  
aws logs describe-log-groups \
  --log-group-name-prefix "/apigw/brainsway-api-staging/v1/" \
  --profile bwamazonstaging

# Check production environment logs
aws logs describe-log-groups \
  --log-group-name-prefix "/apigw/brainsway-api-prod/v1/" \
  --profile bwamazonprod
```

### **SSL Certificate Status**
```bash
# Verify certificates are in ISSUED status
aws acm list-certificates --certificate-statuses ISSUED --profile bwamazondev
aws acm list-certificates --certificate-statuses ISSUED --profile bwamazonstaging  
aws acm list-certificates --certificate-statuses ISSUED --profile bwamazonprod
```

---

## ğŸ” **Troubleshooting**

### **DNS Issues**
```bash
# If delegation isn't working, check NS records in parent zone
aws route53 list-resource-record-sets \
  --hosted-zone-id ZPARENT_ZONE_ID \
  --query "ResourceRecordSets[?Name=='dev.brainsway.cloud.']" \
  --profile bwamazonprod

# Check name servers from child zone match delegation
aws route53 get-hosted-zone \
  --id ZCHILD_ZONE_ID \
  --query "DelegationSet.NameServers" \
  --profile bwamazondev
```

### **SSL Certificate Issues** 
```bash
# Check certificate validation records
aws acm describe-certificate \
  --certificate-arn CERTIFICATE_ARN \
  --query "Certificate.DomainValidationOptions" \
  --profile bwamazondev
```

### **API Gateway Issues**
```bash
# Check custom domain configuration
aws apigatewayv2 get-domain-names --profile bwamazondev

# Test API Gateway directly (bypass custom domain)
curl https://API_ID.execute-api.us-east-2.amazonaws.com/v1/health
```

---

## ğŸ“Š **Key Architecture Points**

### **âœ… HTTP API v2 Configuration**
- **No Stage Variables**: Environment-specific configuration handled via Lambda environment variables
- **CORS**: Configured directly on API Gateway (not Lambda)
- **Custom Domains**: Regional endpoints with ACM certificates

### **âœ… Route53 Records** 
- **A/AAAA Records**: Created explicitly by Terraform `apigw_http_proxy` module
- **NOT**: Auto-created by API Gateway (common misconception)
- **TTL**: 300 seconds during rollout, increase to 3600 after stabilization

### **âœ… CloudWatch Logs**
- **Path Pattern**: `/apigw/${api_name}/${stage_name}/access`
- **NOT**: `/aws/apigatewayv2/...` (different service pattern)
- **Format**: JSON structured logs with comprehensive request metadata

---

## ğŸ”’ **Security Features**

### **Environment-Specific Security**
- **Dev**: Permissive CORS (*), DEBUG logging, no concurrency limits
- **Staging**: Restrictive CORS, INFO logging, moderate concurrency limits  
- **Production**: Very restrictive CORS, WARN logging, high concurrency, WAF protection

### **Cross-Account Security**
- IAM roles with least privilege access
- Encrypted state buckets in each account
- Comprehensive tagging for compliance (SOC2, cost allocation)

---

## ğŸ“ˆ **Post-Deployment**

### **Monitoring Setup**
1. Configure SNS topics for CloudWatch alarms
2. Set up dashboard for API Gateway metrics
3. Configure log analysis and alerting

### **DNS TTL Optimization**
1. Keep TTL=300 for first week (fast changes)
2. Increase to TTL=3600 after stabilization
3. Monitor DNS query patterns and costs

### **Performance Tuning**
1. Adjust Lambda memory based on actual usage
2. Configure provisioned concurrency for production
3. Optimize CORS origins based on actual client applications

---

## ğŸ“‹ **Rollback Procedures**

### **Emergency DNS Rollback**
```bash
# Remove delegation NS records from parent zone
aws route53 change-resource-record-sets \
  --hosted-zone-id ZPARENT_ZONE_ID \
  --change-batch file://remove-delegation.json \
  --profile bwamazonprod
```

### **Infrastructure Rollback**
```bash
# Destroy in reverse order of creation
terragrunt destroy  # From each directory in reverse deployment order
```

---

**âœ… Deployment Complete**: All validation commands should pass and API endpoints should be accessible via custom domains with proper SSL certificates and DNS delegation.