version: 1
collect_usage_data: false
auto_merge: false
projects:
  - name: dev
    dir: infra/live/dev
    terragrunt: true
    workflow: terragrunt-dev
    include_patterns:
      - "infra/live/dev/**"
  - name: staging
    dir: infra/live/staging
    terragrunt: true
    workflow: terragrunt-staging
    include_patterns:
      - "infra/live/staging/**"
  - name: prod
    dir: infra/live/prod
    terragrunt: true
    workflow: terragrunt-prod
    include_patterns:
      - "infra/live/prod/**"
workflows:
  terragrunt-dev:
    plan:
      steps:
        - run: terragrunt run-all plan -no-color -parallelism 4
    apply:
      steps:
        - run: terragrunt run-all apply -auto-approve -no-color -parallelism 2
  terragrunt-staging:
    plan:
      steps:
        - run: terragrunt run-all plan -no-color -parallelism 4
    apply:
      steps:
        - run: |
            echo "ğŸš¨ Staging deployment requires manual approval"
            echo "Only proceed if changes have been reviewed and approved"
            terragrunt run-all apply -auto-approve -no-color -parallelism 2
  terragrunt-prod:
    plan:
      steps:
        - run: |
            echo "ğŸ“‹ Production is READ-ONLY - showing plan for review"
            terragrunt run-all plan -no-color -parallelism 4
    apply:
      steps:
        - run: |
            echo "ğŸ¯ TEMPORARY: Allowing production applies for DNS infrastructure only"
            echo "ğŸ“ Targeting ONLY: /apigw-http/ directory (DNS zones and delegation)"
            echo "ğŸ”’ All other production resources remain protected"
            echo "âš ï¸  This override will be reverted after DNS deployment"
            echo ""
            echo "ğŸš€ Deploying DNS infrastructure..."
            terragrunt run-all apply --terragrunt-include-dir apigw-http/ -auto-approve -no-color -parallelism 2